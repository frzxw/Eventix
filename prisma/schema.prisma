// Prisma Database Schema for Eventix Ticketing Platform
// Database: Azure Database for PostgreSQL Flexible Server
// ORM: Prisma

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

// ============================================================================
// USERS & AUTHENTICATION
// ============================================================================

model User {
  id                String      @id @default(cuid())
  email             String      @unique
  passwordHash      String
  firstName         String
  lastName          String
  phone             String?
  profileImageUrl   String?
  emailVerified     Boolean     @default(false)
  emailVerifiedAt   DateTime?
  createdAt         DateTime    @default(now())
  updatedAt         DateTime    @updatedAt

  // Relations
  orders            Order[]
  sessions          Session[]
  reviewedEvents    EventReview[]

  @@index([email])
  @@index([createdAt])
}

model Session {
  id                String      @id @default(cuid())
  userId            String
  tokenHash         String      @unique
  refreshTokenHash  String      @unique
  deviceInfo        String?
  ipAddress         String?
  expiresAt         DateTime
  createdAt         DateTime    @default(now())
  revokedAt         DateTime?

  // Relations
  user              User        @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([expiresAt])
}

// ============================================================================
// EVENTS & VENUES
// ============================================================================

model Event {
  id                String      @id @default(cuid())
  title             String
  description       String
  // Category (concert, festival, theater, comedy, sports, other)
  category          String      @db.VarChar(50)
  date              DateTime
  year              Int         // Extracted from date for indexing
  organizerId       String?
  // Status (active, cancelled, postponed, completed)
  status            String      @default("active") @db.VarChar(20)
  
  // Venue Information
  venueName         String
  venueAddress      String?
  venueCity         String
  venueCapacity     Int
  
  // Media
  imageUrl          String?
  bannerImageUrl    String?
  
  // Metadata
  tags              String      // JSON array stored as string
  isFeatured        Boolean     @default(false)
  viewCount         Int         @default(0)
  
  createdAt         DateTime    @default(now())
  updatedAt         DateTime    @updatedAt

  // Relations
  ticketCategories  TicketCategory[]
  orders            Order[]
  reviews           EventReview[]

  @@index([category])
  @@index([date])
  @@index([venueCity])
  @@index([isFeatured])
  @@index([status])
  @@index([year])
}

model EventReview {
  id                String      @id @default(cuid())
  eventId           String
  userId            String
  rating            Int         // 1-5
  comment           String?
  createdAt         DateTime    @default(now())

  // Relations
  event             Event       @relation(fields: [eventId], references: [id], onDelete: NoAction)
  user              User        @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([eventId, userId])
  @@index([eventId])
  @@index([userId])
}

// ============================================================================
// TICKETS & CATEGORIES
// ============================================================================

model TicketCategory {
  id                String      @id @default(cuid())
  eventId           String      @map("event_id")
  name              String      // GENERAL, VIP, CAT1, etc.
  displayName       String      @map("display_name")
  description       String?
  price             Decimal     @db.Decimal(10, 2)
  currency          String      @default("IDR")
  
  // Availability
  quantityTotal     Int         @map("quantity_total")
  quantitySold      Int         @default(0) @map("quantity_sold")
  
  // Metadata
  benefits          String      // JSON array stored as string
  sortOrder         Int         @default(0) @map("sort_order")
  
  createdAt         DateTime    @default(now()) @map("created_at")
  updatedAt         DateTime    @updatedAt @map("updated_at")

  // Relations
  event             Event       @relation(fields: [eventId], references: [id], onDelete: Cascade)
  tickets           Ticket[]

  @@index([eventId])
  @@map("ticket_categories")
}

model Ticket {
  id                String      @id @default(cuid())
  ticketNumber      String      @unique @map("ticket_number")
  orderId           String      @map("order_id")
  eventId           String      @map("event_id")
  categoryId        String      @map("category_id")
  
  // QR Code & Barcode
  qrCodeUrl         String?     @map("qr_code_url") // URL to QR code image in blob storage
  qrCodeData        String      @unique @map("qr_code_data") // Raw QR code data for scanning
  barcodeData       String?     @unique @map("barcode_data")
  
  // Status
  // Status (valid, used, cancelled, transferred)
  status            String      @default("valid") @db.VarChar(20)
  usedAt            DateTime?   @map("used_at")
  scannedBy         String?     @map("scanned_by") // Security personnel identifier
  
  // Transfer
  transferredToEmail String? @map("transferred_to_email")
  transferredAt     DateTime?   @map("transferred_at")
  originalOrderId   String?     @map("original_order_id") // Original order before transfer
  
  createdAt         DateTime    @default(now()) @map("created_at")

  // Relations
  order             Order       @relation(fields: [orderId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  category          TicketCategory @relation(fields: [categoryId], references: [id], onDelete: NoAction, onUpdate: NoAction)

  @@index([orderId])
  @@index([eventId])
  @@index([status])
  @@index([qrCodeData])
  @@map("tickets")
}

// ============================================================================
// ORDERS & PAYMENTS
// ============================================================================

model Order {
  id                String      @id @default(cuid())
  orderNumber       String      @unique @map("order_number") // EVX-2025-XXXXX
  userId            String?     @map("user_id")
  eventId           String      @map("event_id")
  holdToken         String      @unique @map("hold_token")
  
  // Booking Status (pending, confirmed, cancelled, refunded)
  status            String      @default("pending_payment") @db.VarChar(20)
  
  // Attendee Information
  attendeeFirstName String      @map("attendee_first_name")
  attendeeLastName  String      @map("attendee_last_name")
  attendeeEmail     String      @map("attendee_email")
  attendeePhone     String      @map("attendee_phone")
  
  // Pricing
  subtotal          Decimal     @db.Decimal(10, 2)
  serviceFee        Decimal     @db.Decimal(10, 2) @default(0) @map("service_fee")
  processingFee     Decimal     @db.Decimal(10, 2) @default(0) @map("processing_fee")
  tax               Decimal     @db.Decimal(10, 2) @default(0)
  discount          Decimal     @db.Decimal(10, 2) @default(0)
  totalAmount       Decimal     @db.Decimal(10, 2) @map("total_amount")
  currency          String      @default("IDR")
  
  // Promo Code
  promoCodeUsed     String?     @map("promo_code_used")
  
  // Payment
  paymentMethod     String?     @map("payment_method")    // credit_card, bank_transfer, e_wallet, etc.
  // Payment Status (pending, processing, completed, failed, refunded)
  paymentStatus     String      @default("pending") @db.VarChar(20) @map("payment_status")
  paymentReference  String?     @map("payment_reference") // Payment gateway reference
  paidAt            DateTime?   @map("paid_at")
  
  createdAt         DateTime    @default(now()) @map("created_at")
  updatedAt         DateTime    @updatedAt @map("updated_at")
  expiresAt         DateTime?   @map("expires_at") // Order expiration for payment

  // Relations
  user              User?       @relation(fields: [userId], references: [id], onDelete: Cascade)
  event             Event       @relation(fields: [eventId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  tickets           Ticket[]
  orderItems        OrderItem[]
  paymentDetails    PaymentLog[]

  @@index([userId])
  @@index([eventId])
  @@index([status])
  @@index([paymentStatus])
  @@index([orderNumber])
  @@index([createdAt])
  @@map("orders")
}

model OrderItem {
  id          String   @id @default(cuid())
  orderId     String   @map("order_id")
  categoryId  String   @map("category_id")
  quantity    Int
  unitPrice   Decimal  @db.Decimal(10, 2) @map("unit_price")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  order       Order        @relation(fields: [orderId], references: [id], onDelete: Cascade)
  category    TicketCategory @relation(fields: [categoryId], references: [id], onDelete: NoAction)

  @@unique([orderId, categoryId])
  @@index([categoryId])
  @@map("order_items")
}

model PaymentLog {
  id                String      @id @default(cuid())
  orderId           String      @map("order_id")
  
  paymentMethod     String
  amount            Decimal     @db.Decimal(10, 2)
  currency          String
  // Payment Status (pending, processing, completed, failed, refunded)
  status            String      @db.VarChar(20)
  
  gatewayReference  String?     @map("gateway_reference")
  gatewayResponse   String?     @map("gateway_response") // JSON response from payment gateway
  
  errorMessage      String?     @map("error_message")
  
  createdAt         DateTime    @default(now()) @map("created_at")

  // Relations
  order             Order       @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@index([orderId])
  @@index([status])
  @@map("payment_logs")
}

model ApiIdempotency {
  id                 String   @id @default(cuid())
  idempotencyKey     String   @unique @db.VarChar(150) @map("idempotency_key")
  status             String   @db.VarChar(20)
  requestFingerprint String? @db.VarChar(2000) @map("request_fingerprint")
  holdToken          String?  @db.VarChar(150) @map("hold_token")
  responsePayload    Json?    @map("response_payload")
  createdAt          DateTime  @default(now()) @map("created_at")
  updatedAt          DateTime  @updatedAt @map("updated_at")
  completedAt        DateTime? @map("completed_at")
  expiresAt          DateTime? @map("expires_at")

  @@index([expiresAt])
  @@map("api_idempotency")
}

// ============================================================================
// PROMO CODES
// ============================================================================

model PromoCode {
  id                String      @id @default(cuid())
  code              String      @unique
  
  description       String?
  // DiscountType (percentage, fixed_amount)
  discountType      String      @db.VarChar(20)
  discountValue     Decimal     @db.Decimal(10, 2)
  
  maxUsageCount     Int?        // Null = unlimited
  usageCount        Int         @default(0)
  
  maxUsagePerUser   Int         @default(1)
  
  // Restrictions
  minimumOrderAmount Decimal?   @db.Decimal(10, 2)
  // JSON array of categories (string[]). Empty = all
  applicableCategories String?
  
  // Validity
  validFrom         DateTime
  validUntil        DateTime
  isActive          Boolean     @default(true)
  
  createdAt         DateTime    @default(now())
  updatedAt         DateTime    @updatedAt

  @@index([code])
  @@index([isActive])
  @@index([validFrom])
  @@index([validUntil])
}

// ============================================================================
// AUDIT & LOGGING
// ============================================================================

model AuditLog {
  id                String      @id @default(cuid())
  action            String      // create, update, delete, etc.
  resourceType      String      // Event, Order, User, etc.
  resourceId        String
  userId            String?
  
  changes           String?     // JSON of before/after
  ipAddress         String?
  userAgent         String?
  
  createdAt         DateTime    @default(now())

  @@index([resourceType])
  @@index([resourceId])
  @@index([userId])
  @@index([createdAt])
}

model SystemLog {
  id                String      @id @default(cuid())
  level             String      // info, warn, error, debug
  message           String
  context           String?     // JSON context data
  
  createdAt         DateTime    @default(now())

  @@index([level])
  @@index([createdAt])
}
